# Milestone 0.4 — UI 体验与基础交互全面升维

## 1. 目标

在前序完善基础功能与数据管理的基础上，解决用户高频操作中遇到的各种细节痛点。涵盖 Bug 精准消杀、原生组件替换、核心功能改进（包括有序主键、全局防抖）、并注入丝滑的动画体验与高级图表交互。

## 2. 需求详情及完成情况

### 2.1 第一阶段：高优先级 Bug 修复
| 状态 | 需求项            | 详情                                                                                                                         |
| ---- | ----------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| ✅    | 下拉选择修复      | 修复首页“添加账户类型”及“记一笔分类”下拉组件失去响应的失效问题。                                                             |
| ✅    | 备注长度限制      | 限制最大录入 50 字符，超长时提供实时 UI 提示并在数据源拦截。                                                                 |
| ✅    | 彻底移除转账      | 梳理全局代码结构，彻底清理残留的转账 Enum 声明、数据类型校验、处理逻辑代码及 Markdown 相关引用。                             |
| ✅    | 修复导入 TXT 异常 | 排查并解决了 TXT 导入历史账单时错误随机生成“支付宝”、“现金”冗余账户的 Bug。                                                  |
| ✅    | 全局替换 alert    | 查找项目中所有原生丑陋的 `alert()` / `confirm()` 方法，并全量使用自定义弹窗及 Toast 组件替换以保持极佳的 UI 统一。           |
| ✅    | 英文提示本地化    | 对 Toast 的默认英文文案执行了全量本地汉化。                                                                                  |
| ✅    | TXT导入账户流闭环 | TXT 导入增加智能预检机制：如果无对应账户 -> 系统自动静默创建；如有存量账户 -> 弹出全局弹窗提示用户人工选择欲挂载的目标账户。 |
| ✅    | 统计时间选择器    | 提取维度判断，呈现差异化且互斥的选择组件：(按日→日历、按月→年月盘、按年→年份列表盘、按周→自动圈定周)。加大水平边距修复叠字。 |

### 2.2 第二阶段：核心功能改进
| 状态 | 需求项            | 详情                                                                                                                                                                                                                    |
| ---- | ----------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ✅    | 分类联想检索      | 添加分类处支持防抖(Debounce) 的拼音/中文输入，下方原有的折叠分类树会联动自动过滤展示并高亮匹配字符。                                                                                                                    |
| ✅    | UUID 序贯主键重构 | 采用零依赖的 `Date.now() + index` （如 `YYYYMMDDHHMMSSms_随机`）自研字符串，替代乱序的 `uuidv4`；不仅抹平依赖，更为历史 TXT 同分钟条目补齐顺序一致的主键；在导入前新增批量比对防重，弹窗交予用户选择保留/跳过，极稳固。 |

### 2.3 第三阶段：UI/UX 体验交互进阶
| 状态 | 需求项           | 详情                                                                                                                                    |
| ---- | ---------------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| ✅    | Framer Tab 动画  | 为“记一笔”引入强大的 Framer Motion，利用 Shared Layout 打造点击后物理丝滑顺移的下划线切换交互。                                         |
| ✅    | 金额竖直高频排版 | 利用 Flex+Translate 补正金额款左侧的 ¥ 符号垂直死区。                                                                                   |
| ✅    | 饼图图表重载     | 修改 Recharts 的底层结构：尾部（<2.5%的偏门分类）自动聚合折叠为“其他”项；外挂联动鼠标 Hover 的发光放大高亮，抹除所有堆叠脏 Label 显示。 |

## 3. 技术决策 & 选型分析回溯

- **去依赖化思维持续深耕：**
  在主键序列化生成的时候坚决拥抱标准 API（放弃 `ulid` 包），不仅显著改善由于纯原生无序 UUID 所带来的 TXT 序列恢复倒错，也兼顾本地程序的独立运行性原则。
- **高级物理动画引入:**
  确认 Shadcn 无法在简单伪类下解决滑动跟手物理动画，直接拍板引入业界标准 `framer-motion` 作为此版及将来的核心级动效主力，快速通过 `layoutId` 实现优雅切换。

*完结时间：2026-02-21*
---
# Milestone v0.4.1 (Patch 1)

## 📌 目标
修复 Milestone 0.4 中遗留的“其他”分类合并冲突 BUG 与配色重复 BUG，并引入更为强大的 XLSX 报表原生导出功能。

## 📍 已完成任务

### 1. 修复统计图表“其他”项冲突问题 (Bugfix)
- **原因分析**：内置系统存在的收、支两个名为“其他”的项，遇到了 `CategoryBreakdown` 组件动态聚合（当占比<2.5%时）时硬编码命名为“其他”的逻辑。使得最后出现 React 的 Key 重叠，引发 hover 与点击状态混乱。
- **解决方案**：引入了隔离命名，将聚合项命名为 `其他聚合 (共X项)` 并在内部附带真实唯一 id 用作渲染 key。该项支持下钻展开查看被隐藏的散碎金额项，交互体验大幅上升。

### 2. 饼图色彩循环冲撞问题 (Bugfix)
- **原因分析**：硬编码了 10 个颜色，分类超出时按取余回绕生成，导致不同分类视觉无法区分。
- **解决方案**：移除了硬编码颜色组。采用基于黄金角度（Golden Angle 137.5°）递增的 HSL 色彩生成策略：`hsl((i * 137.5) % 360, 70%, 50%)`。确保无穷尽的分类也能展现出分化且视觉友好的配色序列。

### 3. 数据分析功能加强：导出 XLSX (Feature)
- **原因分析**：之前利用旧版 txt 或者基础 csv 导出含有数字的数据时，在本地 Excel 打开极易转为科学计数法，破坏账单金额。
- **解决方案**：彻底引入轻量而强大的社区版 `xlsx`，在本地直接在浏览器中构建内存级 Excel File，精准将金额定义为纯数值，名称/日期等定为文本类别，确保后续复杂的二次使用需求完美达成。

## 🛠 技术决策记录

- **引入第三方库**：`xlsx` (SheetJS)
  - _决策理由_：在分析导出的需求中，手写带 BOM 的 CSV 往往无法有效避免 Excel 的自动转码截断问题。而生成原生 XLSX 是根本解药。在可控依赖增加中能换取巨大的业务鲁棒性，合理。
- **UI 下钻**：
  - _决策理由_：没有选择引入额外的弹窗或是层叠饼图，为了遵循本应用 KISS (Keep It Simple, Stupid) 原则。在下方已有列表处支持内联展开就是最低认知负担且最容易实现的平替途径。

---
_完成时间：2026-02_
