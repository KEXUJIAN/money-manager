# Milestone 0.3 — 记账交互与数据管理优化

## 1. 目标

精简记账流程，优化分类管理体验，修正数据导出逻辑。

## 2. 需求详情

### 2.1 记账功能重构

| 需求项           | 详情                                                                                      |
| ---------------- | ----------------------------------------------------------------------------------------- |
| **移除转账**     | 彻底移除"转账"Tab 及所有相关代码逻辑（`toAccountId` 字段保留兼容历史数据，不删除 Schema） |
| **下拉默认值**   | 支出/收入界面，账户和分类下拉框必须有默认选中值（列表第一项），禁止为空                   |
| **时间精度升级** | 日期选择器精确到"分钟"（YYYY-MM-DD HH:mm），默认值为打开侧边栏的当前时间，秒数归零存储    |
| **备注自动填充** | 备注为空时，保存自动将分类名称填入备注                                                    |

### 2.2 分类管理优化（设置页面）

| 需求项       | 详情                                                     |
| ------------ | -------------------------------------------------------- |
| **折叠面板** | 支出/收入分类列表实现手风琴效果，默认收起                |
| **删除弹窗** | 移除原生 `alert`/`confirm`，统一使用 `ConfirmationModal` |

### 2.3 数据导出修正

| 需求项       | 详情                              |
| ------------ | --------------------------------- |
| **排序逻辑** | TXT 导出按时间升序（最早 → 最新） |

## 3. 技术方案

### 3.1 文件变更总览

| 文件                                                               | 操作 | 说明                                                |
| ------------------------------------------------------------------ | ---- | --------------------------------------------------- |
| `src/features/transactions/components/AddTransactionSheet.tsx`     | 修改 | 移除转账、默认值、时间精确到分钟、备注逻辑          |
| `src/routes/Settings.tsx`                                          | 修改 | 折叠面板 + ConfirmationModal 替换 alert/confirm     |
| `src/features/data-management/components/DataManagementDialog.tsx` | 修改 | TXT 导出排序                                        |
| `src/features/data-management/utils.ts`                            | 修改 | `generateLegacyTxt` 排序                            |
| `src/db/index.ts`                                                  | 修改 | Category.type 移除 'transfer'（可选，影响面需评估） |

### 3.2 关键实现细节

#### 移除转账
- 删除 TabsTrigger `transfer`，`grid-cols-3` → `grid-cols-2`
- 删除 `toAccountId` 相关 FormField
- 删除 formSchema 中 transfer 相关 refine 校验
- 删除 onSubmit 中转账余额逻辑
- 保留 DB Schema 的 `toAccountId` 字段（兼容历史数据）

#### 时间选择器
- 使用原生 `<input type="datetime-local">` 替代 Calendar+Popover 组合
- `step="60"` 限制精度到分钟
- 默认值：`new Date()` 秒数归零
- 存储前强制 `setSeconds(0, 0)`

#### 折叠面板
- 使用 Shadcn/UI 的 Collapsible 组件（需安装）
- 或用简单的 CSS + state 手动实现（避免新依赖）
- **推荐**：手动实现，仅需 `useState<boolean>` 控制 `display` / `max-height`，无需额外依赖

#### 导出排序
- `transactions.sort((a, b) => a.date - b.date)` 在生成 TXT 前排序

## 4. 验证计划

### 浏览器验证
1. 打开"记一笔"侧边栏，确认只有"支出"和"收入"两个 Tab
2. 确认账户和分类下拉有默认选中值
3. 确认时间选择器精确到分钟，默认为当前时间
4. 提交空备注的记录，检查数据库中 note 是否等于分类名
5. 进入设置页面，确认收入/支出分类默认收起，点击可展开
6. 点击删除自定义分类，确认弹出自定义 Modal
7. 导出 TXT 文件，打开检查排序是否从旧到新

### 请用户手动确认
- 导出 TXT 文件内容的排序正确性
- 折叠面板交互的流畅度

## 5. Patch 1 — 数据联动、搜索增强与UI修正

### 5.1 记一笔功能修复

| 需求项         | 详情                                                                     |
| -------------- | ------------------------------------------------------------------------ |
| **搜索下拉**   | 账户/分类下拉框支持关键词搜索，数据从设置实时同步                        |
| **时间选择器** | 替换原生 datetime-local 为自定义 DateTimePicker（Calendar + 时分Select） |
| **默认时间**   | 打开侧边栏时默认填充当前时间，"现在"按钮可快速恢复                       |

### 5.2 分类管理逻辑增强

| 需求项         | 详情                           |
| -------------- | ------------------------------ |
| **同类型防重** | 同一分类类型下不允许同名分类   |
| **跨类型允许** | 收入和支出可以有同名分类       |
| **空值校验**   | 空名称提交时 Toast 提示        |
| **搜索过滤**   | 分类列表内增加搜索框，实时过滤 |

### 5.3 新增组件与依赖

- 新增依赖：`sonner`
- 新增组件：`searchable-select.tsx`、`date-time-picker.tsx`、`sonner.tsx`

